<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ç—Ä—É–¥–æ–≤–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/window.css">
  <link rel="stylesheet" href="/css/form.css">
</head>

<body>

<div class="main-window window-form">

  <!-- TITLEBAR -->
  <div class="window-titlebar">
    <div class="window-title">
      <img src="https://win98icons.alexmeub.com/icons/png/checklist-0.png" width="20">
      <span>–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –¥–æ–≥–æ–≤–æ—Ä–∞</span>
    </div>
    <div class="window-button" onclick="location.href='contract-list.html'">√ó</div>
  </div>

  <!-- CONTENT -->
  <div class="window-content">

    <div id="loading" class="loading">‚åõ –ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <form id="statusForm" hidden>

      <div class="form-group">
        <label>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å</label>
        <input id="currentStatus" disabled>
      </div>

      <div class="form-group">
        <label for="statusSelect">–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å *</label>
        <select id="statusSelect" required>
          <option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
          <option value="NOT_SIGNED">–ù–µ –ø–æ–¥–ø–∏—Å–∞–Ω</option>
          <option value="HIRED">–î–µ–π—Å—Ç–≤—É–µ—Ç</option>
          <option value="RESIGNED">–†–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç</option>
        </select>
      </div>

      <div class="button-container">
        <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <a href="contract-list.html" class="button">‚ùå –û—Ç–º–µ–Ω–∞</a>
      </div>

    </form>

  </div>
</div>

<!-- Toast -->
<div id="toast-container"></div>
<script src="/js/ui-toast.js"></script>

<!-- Logic -->
<script>
  const CONTRACTS_API = "http://localhost:8081/api/contracts";
  // const CONTRACTS_API = '/api/contracts';

  const params = new URLSearchParams(location.search);
  const contractId = params.get('id');

  const loading = document.getElementById('loading');
  const form = document.getElementById('statusForm');
  const currentStatusInput = document.getElementById('currentStatus');
  const statusSelect = document.getElementById('statusSelect');

  const statusMap = {
    NOT_SIGNED: '–ù–µ –ø–æ–¥–ø–∏—Å–∞–Ω',
    HIRED: '–î–µ–π—Å—Ç–≤—É–µ—Ç',
    RESIGNED: '–†–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç'
  };

  if (!contractId) {
    toast.error('–ù–µ –ø–µ—Ä–µ–¥–∞–Ω ID –¥–æ–≥–æ–≤–æ—Ä–∞');
    loading.remove();
  } else {
    loadContract();
  }

  async function loadContract() {
    try {
      const res = await fetch(`${CONTRACTS_API}/${contractId}`);
      if (!res.ok) throw new Error(res.status);

      const data = await res.json();

      currentStatusInput.value =
        statusMap[data.laborContractStatus] ?? data.laborContractStatus;

      statusSelect.value = data.laborContractStatus;

      loading.remove();
      form.hidden = false;
    } catch (err) {
      console.error(err);
      loading.remove();
      toast.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–≥–æ–≤–æ—Ä–∞');
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const status = statusSelect.value;
    if (!status) {
      toast.error('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å');
      return;
    }

    try {
      toast.info('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞...');

      const res = await fetch(
        `${CONTRACTS_API}/${contractId}/status?status=${status}`,
        {method: 'PATCH'}
      );

      if (!res.ok) throw new Error(res.status);

      toast.success('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω');

      setTimeout(() => {
        location.href = 'contract-list.html';
      }, 800);
    } catch (err) {
      console.error(err);
      toast.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
    }
  });
</script>

<script src="/js/ui-draggable.js"></script>
</body>
</html>
