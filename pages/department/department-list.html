<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–ø–∏—Å–æ–∫ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π</title>
  <script src="/js/auth.js"></script>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <!-- Base styles -->
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/window.css">
  <link rel="stylesheet" href="/css/search.css">
  <link rel="stylesheet" href="/css/list.css">
  <link rel="stylesheet" href="/css/table.css">
</head>

<body>

<div class="desktop">
  <div class="main-window">
    <!-- TITLEBAR -->
    <div class="window-titlebar">
      <div class="window-title">
        <img src="https://win98icons.alexmeub.com/icons/png/users-4.png">
        <span>–°–ø–∏—Å–æ–∫ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π</span>
      </div>
      <div class="window-button" onclick="location.href='department.html'">√ó</div>
    </div>

    <!-- TOOLBAR -->
    <div class="toolbar">
      <a href="department-create.html" class="toolbar-button">
        ‚ûï –î–æ–±–∞–≤–∏—Ç—å
      </a>
      <!-- ‚úÖ SEARCH -->
      <div class="search-container">
        <span style="font-size: 10px; color: #000;">–ü–æ–∏—Å–∫ ID:</span>
        <input type="number" id="searchInput" placeholder="ID">
        <button class="toolbar-button" onclick="searchDepartment()">üîç –ù–∞–π—Ç–∏</button>
        <button class="toolbar-button" onclick="clearSearch()">‚úñ –û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </div>
    <div id="message"></div>

    <!-- CONTENT -->
    <div class="window-content">
      <div class="table-scope">
        <table>
          <thead>
          <tr>
            <th style="width:120px">ID</th>
            <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
            <th style="width:220px">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
          </thead>

          <tbody id="departmentTableBody">
          <tr>
            <td colspan="3" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
  // const API_URL = "http://localhost:8081/api/departments";
  const API_URL = '/api/departments';
  let allDepartments = [];

  async function loadDepartments() {
    const tbody = document.getElementById('departmentTableBody');
    try {
      const response = await apiFetch(API_URL);
      const data = await response.json();
      allDepartments = data;
      displayDepartments(data);
    } catch {
      tbody.innerHTML = '<tr><td colspan="3">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
    }
  }

  function displayDepartments(departments) {
    const tbody = document.getElementById('departmentTableBody');
    tbody.innerHTML = '';

    if (!departments.length) {
      tbody.innerHTML = '<tr><td colspan="3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      return;
    }

    departments.forEach(dept => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${dept.id}</td>
        <td>${dept.name}</td>
        <td>
          <div class="actions">
            <button onclick="editDepartment(${dept.id})">‚úè EDIT</button>
            <button class="delete" onclick="deleteDepartment(${dept.id}, '${dept.name}')">üóë DEL</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function searchDepartment() {
    const id = Number(document.getElementById('searchInput').value);
    if (!id) return;
    displayDepartments(allDepartments.filter(d => d.id === id));
  }

  function clearSearch() {
    document.getElementById('searchInput').value = '';
    displayDepartments(allDepartments);
  }

  function editDepartment(id) {
    location.href = `department-edit.html?id=${id}`;
  }

  async function deleteDepartment(id, name) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ "${name}"?`)) return;
    await apiFetch(`${API_URL}/${id}`, {method: 'DELETE'});
    loadDepartments();
  }

  window.addEventListener('DOMContentLoaded', loadDepartments);
</script>

<script src="/js/ui-draggable.js"></script>
</body>
</html>
