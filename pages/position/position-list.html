<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–°–ø–∏—Å–æ–∫ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π</title>

  <!-- Pixel font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/window.css">
</head>

<body>

<div class="desktop">
  <div class="main-window">

    <!-- TITLEBAR -->
    <div class="window-titlebar">
      <div class="window-title">
        <img src="https://win98icons.alexmeub.com/icons/png/briefcase-4.png" width="20">
        <span>–°–ø–∏—Å–æ–∫ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π</span>
      </div>
      <div class="window-button" onclick="location.href='index.html'">√ó</div>
    </div>

    <!-- TOOLBAR -->
    <div class="toolbar">
      <a href="position-create.html" class="toolbar-button">‚ûï –î–æ–±–∞–≤–∏—Ç—å</a>

      <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
        <span style="font-size:10px;color:#000">–ü–æ–∏—Å–∫ ID:</span>
        <input type="number" id="searchInput" style="width:120px">
        <button class="toolbar-button" onclick="search()">üîç</button>
        <button class="toolbar-button" onclick="reset()">‚úñ</button>
      </div>
    </div>

    <!-- CONTENT -->
    <div class="window-content">
      <table>
        <thead>
        <tr>
          <th>ID</th>
          <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
          <th>–í–∏–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</th>
          <th>–°—É–º–º–∞</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
        </thead>
        <tbody id="tableBody">
        <tr>
          <td colspan="5" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
        </tr>
        </tbody>
      </table>
    </div>

  </div>
</div>

<script>
  const API = '/api/positions';
  let all = [];

  /* ===============================
     LOAD
  =============================== */
  async function load() {
    try {
      const res = await fetch(API);
      if (!res.ok) throw new Error(res.status);
      all = await res.json();
      render(all);
    } catch {
      document.getElementById('tableBody').innerHTML =
        '<tr><td colspan="5">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
    }
  }

  /* ===============================
     RENDER (FLAT)
  =============================== */
  function render(list) {
    const body = document.getElementById('tableBody');
    body.innerHTML = '';

    if (!list.length) {
      body.innerHTML = '<tr><td colspan="5">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      return;
    }

    list.forEach(pos => {
      const items = pos.scheduleItems || [];

      if (!items.length) {
        body.appendChild(row({
          id: pos.id,
          name: pos.name,
          earning: '‚Äî',
          amount: '‚Äî',
          actions: actions(pos)
        }));
        return;
      }

      items.forEach((item, i) => {
        body.appendChild(row({
          id: i === 0 ? pos.id : '',
          name: i === 0 ? pos.name : '',
          earning: item.earningTypeName,
          amount: item.amount.toLocaleString('ru-RU'),
          actions: i === 0 ? actions(pos) : ''
        }));
      });
    });
  }

  function row({id, name, earning, amount, actions}) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${id}</td>
      <td>${name}</td>
      <td>${earning}</td>
      <td>${amount}</td>
      <td>${actions}</td>
    `;
    return tr;
  }

  /* ===============================
     ACTIONS
  =============================== */
  function actions(pos) {
    return `
      <div class="actions">
        <button onclick="edit(${pos.id})">‚úè EDIT</button>
        <button class="delete" onclick="del(${pos.id}, '${pos.name}')">üóë DEL</button>
      </div>
    `;
  }

  function edit(id) {
    location.href = `position-edit.html?id=${id}`;
  }

  async function del(id, name) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å "${name}"?`)) return;
    await fetch(`${API}/${id}`, {method: 'DELETE'});
    load();
  }

  /* ===============================
     SEARCH
  =============================== */
  function search() {
    const id = Number(document.getElementById('searchInput').value);
    if (!id) return;
    render(all.filter(p => p.id === id));
  }

  function reset() {
    document.getElementById('searchInput').value = '';
    render(all);
  }

  /* ===============================
     START
  =============================== */
  window.addEventListener('DOMContentLoaded', load);
</script>

<script src="/js/ui-draggable.js"></script>
</body>
</html>
