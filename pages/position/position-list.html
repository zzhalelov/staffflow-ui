<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–°–ø–∏—Å–æ–∫ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π</title>

  <!-- Pixel-—à—Ä–∏—Ñ—Ç -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    /* ===== –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      image-rendering: pixelated;
    }

    body {
      font-family: "Press Start 2P", monospace;
      background-color: #327375;
      color: #fff;
      overflow: hidden;
    }

    .desktop {
      min-height: 100vh;
      padding: 20px 20px 50px;
      position: relative;
    }

    /* ===== –û–°–ù–û–í–ù–û–ï –û–ö–ù–û ===== */
    .main-window {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 95vw;
      max-width: 1200px;
      height: 85vh;
      background-color: #c0c0c0;
      border: 2px outset #fff;
      display: flex;
      flex-direction: column;
    }

    .window-titlebar {
      background: linear-gradient(90deg, #000080, #1084d0);
      color: white;
      padding: 6px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }

    .toolbar {
      background-color: #c0c0c0;
      padding: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .toolbar-button {
      background: silver;
      border: 2px outset #C0C0C0;
      padding: 6px 12px;
      font-size: 10px;
      cursor: pointer;
      text-decoration: none;
      color: #000;
    }

    .window-content {
      flex: 1;
      background-color: #fff;
      overflow: auto;
      padding: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 10px;
    }

    th, td {
      border: 1px solid #808080;
      padding: 6px;
      color: #000;
    }

    th {
      background-color: #c0c0c0;
    }

    tr:nth-child(even) {
      background-color: #f0f0f0;
    }

    tr:hover {
      background-color: #000080;
      color: #fff;
    }

    tr:hover td {
      color: #fff;
    }

    .actions {
      display: flex;
      gap: 4px;
    }

    .actions button {
      font-size: 9px;
      padding: 3px 6px;
      cursor: pointer;
    }

    .delete {
      background: #c00000;
      color: #fff;
    }

    .loading {
      text-align: center;
      padding: 20px;
    }
  </style>
</head>

<body>
<div class="desktop">

  <!-- ===== –û–ö–ù–û ===== -->
  <div class="main-window">

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="window-titlebar">
      <span>–°–ø–∏—Å–æ–∫ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π</span>
      <button onclick="location.href='position.html'">√ó</button>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å -->
    <div class="toolbar">
      <a href="position-create.html" class="toolbar-button">‚ûï –î–æ–±–∞–≤–∏—Ç—å</a>

      <div style="margin-left:auto;">
        ID:
        <input type="number" id="searchInput" style="width:80px">
        <button class="toolbar-button" onclick="searchPosition()">üîç</button>
        <button class="toolbar-button" onclick="clearSearch()">‚úñ</button>
      </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="window-content">
      <table>
        <thead>
        <tr>
          <th>ID</th>
          <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
          <th>–í–∏–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</th>
          <th>–°—É–º–º–∞</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
        </thead>
        <tbody id="positionTableBody">
        <tr>
          <td colspan="5" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
        </tr>
        </tbody>
      </table>
    </div>

  </div>
</div>

<script>
  /* =========================================================
     API –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  ========================================================= */

  const API_URL = '/api/positions';
  let allPositions = [];

  /* =========================================================
     –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π
  ========================================================= */
  async function loadPositions() {
    const tbody = document.getElementById('positionTableBody');

    try {
      const response = await fetch(API_URL);
      if (!response.ok) throw new Error(response.status);

      const data = await response.json();
      allPositions = data;
      displayPositions(data);

    } catch (err) {
      tbody.innerHTML =
        `<tr><td colspan="5">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>`;
    }
  }

  /* =========================================================
     –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
     –û–î–ù–ê –î–û–õ–ñ–ù–û–°–¢–¨ ‚Üí –ù–ï–°–ö–û–õ–¨–ö–û –ù–ê–ß–ò–°–õ–ï–ù–ò–ô
  ========================================================= */
  function displayPositions(positions) {
    const tbody = document.getElementById('positionTableBody');
    tbody.innerHTML = '';

    if (!positions || positions.length === 0) {
      tbody.innerHTML =
        `<tr><td colspan="5">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
      return;
    }

    positions.forEach(pos => {

      // –ï—Å–ª–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π –Ω–µ—Ç
      if (!pos.scheduleItems || pos.scheduleItems.length === 0) {
        tbody.innerHTML += `
        <tr>
          <td>${pos.id}</td>
          <td>${pos.name}</td>
          <td>‚Äî</td>
          <td>‚Äî</td>
          <td>${actionsHtml(pos)}</td>
        </tr>
      `;
        return;
      }

      // –ï—Å–ª–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π –Ω–µ—Å–∫–æ–ª—å–∫–æ
      pos.scheduleItems.forEach((item, index) => {
        tbody.innerHTML += `
        <tr>
          <td>${index === 0 ? pos.id : ''}</td>
          <td>${index === 0 ? pos.name : ''}</td>
          <td>${item.earningTypeName}</td>
          <td>${item.amount.toLocaleString('ru-RU')}</td>
          <td>${index === 0 ? actionsHtml(pos) : ''}</td>
        </tr>
      `;
      });
    });
  }

  /* =========================================================
     HTML –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
  ========================================================= */
  function actionsHtml(pos) {
    return `
    <div class="actions">
      <button onclick="editPosition(${pos.id})">‚úè</button>
      <button class="delete" onclick="deletePosition(${pos.id}, '${pos.name}')">üóë</button>
    </div>
  `;
  }

  /* =========================================================
     –ü–æ–∏—Å–∫
  ========================================================= */
  function searchPosition() {
    const id = Number(document.getElementById('searchInput').value);
    if (!id) return;

    const filtered = allPositions.filter(p => p.id === id);
    displayPositions(filtered);
  }

  function clearSearch() {
    document.getElementById('searchInput').value = '';
    displayPositions(allPositions);
  }

  /* =========================================================
     –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏–µ
  ========================================================= */
  function editPosition(id) {
    location.href = `position-edit.html?id=${id}`;
  }

  async function deletePosition(id, name) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å "${name}"?`)) return;

    await fetch(`${API_URL}/${id}`, {method: 'DELETE'});
    loadPositions();
  }

  /* =========================================================
     –°—Ç–∞—Ä—Ç
  ========================================================= */
  window.addEventListener('DOMContentLoaded', loadPositions);
</script>
</body>
</html>
