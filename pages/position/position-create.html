<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–î–æ–±–∞–≤–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- –®—Ä–∏—Ñ—Ç –≤ —Å—Ç–∏–ª–µ Win98 -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    /* –û–±—â–∏–π —Å—Ç–∏–ª—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    body {
      font-family: "Press Start 2P", monospace;
      background: #327375;
      padding: 20px;
    }

    /* –û–∫–Ω–æ –≤ —Å—Ç–∏–ª–µ Windows 98 */
    .window {
      background: #c0c0c0;
      border: 2px outset #fff;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }

    label {
      font-size: 10px;
      color: #000;
    }

    input, select {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
      border: 2px inset #fff;
      font-family: monospace;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 10px;
    }

    th, td {
      border: 1px solid #808080;
      padding: 6px;
      background: #fff;
      color: #000;
    }

    th {
      background: #c0c0c0;
      border: 2px outset #fff;
    }

    button {
      background: silver;
      border: 2px outset #fff;
      padding: 6px 12px;
      cursor: pointer;
      font-family: "Press Start 2P";
      font-size: 10px;
    }

    button:active {
      border-style: inset;
    }

    .error {
      color: #900;
      font-size: 10px;
      margin-top: 10px;
    }
  </style>
</head>

<body>

<div class="window">
  <h3 style="font-size:12px;color:#000;">–î–æ–±–∞–≤–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å</h3>

  <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ -->
  <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ *</label>
  <input type="text" id="name" placeholder="–ú–µ–Ω–µ–¥–∂–µ—Ä">

  <hr>

  <!-- –í—ã–±–æ—Ä –≤–∏–¥–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è -->
  <label>–í–∏–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</label>
  <select id="earningTypeSelect"></select>

  <!-- –í–≤–æ–¥ —Å—É–º–º—ã -->
  <label>–°—É–º–º–∞</label>
  <input type="number" id="amount" min="0" step="100" placeholder="100000">

  <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è -->
  <button type="button" onclick="addItem()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ</button>

  <!-- –¢–∞–±–ª–∏—Ü–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π –ø–æ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ -->
  <table>
    <thead>
    <tr>
      <th>–í–∏–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</th>
      <th>–°—É–º–º–∞</th>
      <th></th>
    </tr>
    </thead>
    <tbody id="itemsBody"></tbody>
  </table>

  <br>

  <!-- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ -->
  <button onclick="submitForm()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å</button>

  <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö -->
  <div id="message" class="error"></div>
</div>

<script>
  // ============================
  // API endpoints
  // ============================

  const POSITIONS_API = '/api/positions';
  const EARNING_TYPES_API = '/api/earning-types';

  // ============================
  // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
  // ============================

  const earningTypeSelect = document.getElementById('earningTypeSelect');
  const itemsBody = document.getElementById('itemsBody');
  const message = document.getElementById('message');

  // ============================
  // –î–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏ (state)
  // ============================

  // –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∏–¥—ã –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π
  let earningTypes = [];

  // –ù–∞—á–∏—Å–ª–µ–Ω–∏—è, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
  // [{ earningTypeId, amount }]
  let scheduledItems = [];

  // ============================
  // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π
  // ============================

  async function loadEarningTypes() {
    const res = await fetch(EARNING_TYPES_API);
    earningTypes = await res.json();

    // –û—á–∏—â–∞–µ–º select –∏ –¥–æ–±–∞–≤–ª—è–µ–º placeholder
    earningTypeSelect.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
    earningTypes.forEach(et => {
      const option = document.createElement('option');
      option.value = et.id;            // ID –ø–æ–π–¥—ë—Ç –Ω–∞ backend
      option.textContent = `${et.name} (${et.code})`;
      earningTypeSelect.appendChild(option);
    });
  }

  // ============================
  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
  // ============================

  function addItem() {
    const typeId = Number(earningTypeSelect.value);
    const amount = Number(document.getElementById('amount').value);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–≤–æ–¥–∞
    if (!typeId || amount <= 0) {
      message.textContent = '–£–∫–∞–∂–∏—Ç–µ –≤–∏–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∏ —Å—É–º–º—É';
      return;
    }

    // –ó–∞–ø—Ä–µ—â–∞–µ–º –¥—É–±–ª–∏ –≤–∏–¥–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π
    if (scheduledItems.some(i => i.earningTypeId === typeId)) {
      message.textContent = '–≠—Ç–æ—Ç –≤–∏–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω';
      return;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
    scheduledItems.push({
      earningTypeId: typeId,
      amount: amount
    });

    renderItems();
    message.textContent = '';
  }

  // ============================
  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π
  // ============================

  function renderItems() {
    itemsBody.innerHTML = '';

    scheduledItems.forEach((item, index) => {
      // –ù–∞—Ö–æ–¥–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø–æ id
      const et = earningTypes.find(e => e.id === item.earningTypeId);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${et.name}</td>
        <td>${item.amount.toLocaleString('ru-RU')}</td>
        <td>
          <button onclick="removeItem(${index})">üóë</button>
        </td>
      `;

      itemsBody.appendChild(tr);
    });
  }

  // ============================
  // –£–¥–∞–ª–µ–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
  // ============================

  function removeItem(index) {
    scheduledItems.splice(index, 1);
    renderItems();
  }

  // ============================
  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
  // ============================

  async function submitForm() {
    const name = document.getElementById('name').value.trim();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    if (!name || scheduledItems.length === 0) {
      message.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è';
      return;
    }

    // –§–∏–Ω–∞–ª—å–Ω—ã–π payload –ø–æ–¥ backend
    const payload = {
      name: name,
      scheduledItems: scheduledItems
    };

    console.log('–û—Ç–ø—Ä–∞–≤–∫–∞:', payload);

    const res = await fetch(POSITIONS_API, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      message.textContent = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
      return;
    }

    alert('–î–æ–ª–∂–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∞');
    window.location.href = 'position-list.html';
  }

  // ============================
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  // ============================

  loadEarningTypes();
</script>

</body>
</html>
