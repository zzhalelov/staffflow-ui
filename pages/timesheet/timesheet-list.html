<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–ø–∏—Å–æ–∫ —Ç–∞–±–µ–ª–µ–π</title>

  <!-- Pixel font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
    rel="stylesheet"
  >

  <!-- Styles -->
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/window.css">
  <link rel="stylesheet" href="/css/search.css">
  <link rel="stylesheet" href="/css/list.css">
  <link rel="stylesheet" href="/css/table.css">
</head>

<body>

<div class="desktop">
  <div class="main-window">

    <!-- TITLEBAR -->
    <div class="window-titlebar">
      <div class="window-title">
        <img
          src="https://win98icons.alexmeub.com/icons/png/calendar-0.png"
          width="20"
        >
        <span>–°–ø–∏—Å–æ–∫ —Ç–∞–±–µ–ª–µ–π</span>
      </div>
      <div class="window-button" onclick="location.href='index.html'">√ó</div>
    </div>

    <!-- TOOLBAR -->
    <div class="toolbar">
      <a href="timesheet-create.html" class="toolbar-button">
        ‚ûï –î–æ–±–∞–≤–∏—Ç—å
      </a>

      <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
        <span style="font-size:10px;color:#000">–ü–æ–∏—Å–∫ ID:</span>
        <input type="number" id="searchInput" style="width:120px">
        <button class="toolbar-button" onclick="search()">üîç</button>
        <button class="toolbar-button" onclick="reset()">‚úñ</button>
      </div>
    </div>

    <div id="message"></div>

    <!-- CONTENT -->
    <div class="window-content">
      <div class="table-scope">
        <table>
          <thead>
          <tr>
            <th>ID</th>
            <th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th>
            <th>–ü–µ—Ä–∏–æ–¥</th>
            <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
          </thead>
          <tbody id="tableBody">
          <tr>
            <td colspan="5" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script src="/staffflow-ui/js/api.js"></script>
<script src="/staffflow-ui/js/auth.js"></script>
<script>
  // const API = '/api/timesheets';
  let all = [];

  /* ===============================
     LOAD
  =============================== */
  async function load() {
    try {
      const res = await apiFetch('/api/timesheets');
      if (!res.ok) throw new Error(res.status);

      all = await res.json();
      render(all);

    } catch (e) {
      console.error(e);
      document.getElementById('tableBody').innerHTML =
        '<tr><td colspan="5">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
    }
  }

  /* ===============================
     RENDER
  =============================== */
  function render(list) {
    const body = document.getElementById('tableBody');
    body.innerHTML = '';

    if (!list.length) {
      body.innerHTML = '<tr><td colspan="5">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      return;
    }

    list.forEach(ts => {
      body.appendChild(row(ts));
    });
  }

  function row(ts) {
    const tr = document.createElement('tr');

    const period = `${monthRu(ts.month)} ${ts.year}`;
    const employeesCount = ts.entries ? ts.entries.length : 0;

    tr.innerHTML = `
    <td>${ts.id}</td>
    <td>${ts.organization?.name ?? '‚Äî'}</td>
    <td>${period}</td>
    <td>${employeesCount}</td>
    <td>${actions(ts)}</td>
  `;

    return tr;
  }

  /* ===============================
     ACTIONS
  =============================== */
  function actions(ts) {
    return `
      <div class="actions">
        <button onclick="openTimesheet(${ts.id})">
          ‚úè OPEN
        </button>
        <button
          class="delete"
          onclick="del(${ts.id})"
        >
          üóë DEL
        </button>
      </div>
    `;
  }

  function openTimesheet(id) {
    location.href = `timesheet-edit.html?id=${id}`;
  }

  async function del(id) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–∞–±–µ–ª—å #${id}?`)) return;

    try {
      await apiFetch(`/api/timesheets/${id}`, {method: 'DELETE'});
      load();
    } catch {
      alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
    }
  }

  /* ===============================
     SEARCH
  =============================== */
  function search() {
    const id = Number(document.getElementById('searchInput').value);
    if (!id) return;
    render(all.filter(t => t.id === id));
  }

  function reset() {
    document.getElementById('searchInput').value = '';
    render(all);
  }

  /* ===============================
     UTILS
  =============================== */
  function monthRu(month) {
    const map = {
      JANUARY: '–Ø–Ω–≤–∞—Ä—å',
      FEBRUARY: '–§–µ–≤—Ä–∞–ª—å',
      MARCH: '–ú–∞—Ä—Ç',
      APRIL: '–ê–ø—Ä–µ–ª—å',
      MAY: '–ú–∞–π',
      JUNE: '–ò—é–Ω—å',
      JULY: '–ò—é–ª—å',
      AUGUST: '–ê–≤–≥—É—Å—Ç',
      SEPTEMBER: '–°–µ–Ω—Ç—è–±—Ä—å',
      OCTOBER: '–û–∫—Ç—è–±—Ä—å',
      NOVEMBER: '–ù–æ—è–±—Ä—å',
      DECEMBER: '–î–µ–∫–∞–±—Ä—å'
    };
    return map[month] || month;
  }

  /* ===============================
     START
  =============================== */
  window.addEventListener('DOMContentLoaded', load);
</script>

<script src="/js/ui-draggable.js"></script>
</body>
</html>
