<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Табель</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="/js/auth.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
    rel="stylesheet"
  >

  <!-- Styles -->
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/window.css">
  <link rel="stylesheet" href="/css/form.css">

  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 10px;
      color: #000;
      min-width: 1200px;
    }

    th, td {
      border: 1px solid #444;
      padding: 4px;
      text-align: center;
      color: #000;
    }

    .table-scope {
      overflow-x: auto;
      max-width: 100%;
    }

    .window-content {
      overflow-x: auto;
      overflow-y: visible;
    }

    td.day {
      cursor: pointer;
    }

    .WORK {
      background: #4caf50;
    }

    .DAY_OFF {
      background: #9e9e9e;
    }

    .SICK {
      background: #ff9800;
    }

    .VACATION {
      background: #03a9f4;
    }
  </style>
</head>

<body>

<div class="main-window">
  <!-- TITLEBAR -->
  <div class="window-titlebar">
    <div class="window-title">
      <img src="/icons/calendar.png" alt="">
      <span>Табель</span>
    </div>
    <div class="window-button" onclick="history.back()">×</div>
  </div>

  <!-- CONTENT -->
  <div class="window-content">

    <!-- ADD EMPLOYEE -->
    <div class="form-group" style="display:flex; gap:8px; align-items:end">
      <div style="flex:1">
        <label for="employeeSelect">Добавить сотрудника</label>
        <select id="employeeSelect"></select>
      </div>
      <button type="button" onclick="addEmployee()">➕</button>
    </div>

    <!-- TABLE -->
    <div class="table-scope">
      <table id="timesheetTable"></table>
    </div>

  </div>
</div>

<!-- Toast -->
<div id="toast-container"></div>
<script src="/js/ui-toast.js"></script>

<script>
  const API = '/api/timesheets';
  const EMPLOYEES_API = '/api/employees';
  const STATUSES = ['WORK', 'DAY_OFF', 'SICK', 'VACATION'];

  const timesheetId =
    new URLSearchParams(location.search).get('id');

  let timesheet;
  let allEmployees = [];

  /* ===================== LOAD ===================== */

  async function loadTimesheet() {
    const res = await apiFetch(`${API}/${timesheetId}`);
    timesheet = await res.json();

    console.log('TIMESHEET', timesheet);

    await autofillWeekends();
    renderTable();
    await loadEmployees();
  }

  async function loadEmployees() {
    const organizationId =
      timesheet.organization?.id;

    if (!organizationId) return;

    const res = await apiFetch(
      `${EMPLOYEES_API}?organizationId=${organizationId}`
    );
    allEmployees = await res.json();
    renderEmployeeSelect();
  }

  /* ===================== AUTOFILL WEEKENDS ===================== */

  function isWeekend(year, monthIndex, day) {
    const date = new Date(year, monthIndex, day);
    const dow = date.getDay(); // 0 = Sun, 6 = Sat
    return dow === 0 || dow === 6;
  }

  async function autofillWeekends() {
    if (!timesheet || !timesheet.entries) return;

    const monthIndex = new Date(
      `${timesheet.year}-${timesheet.month}-01`
    ).getMonth();

    const daysCount =
      new Date(timesheet.year, monthIndex + 1, 0).getDate();

    for (const entry of timesheet.entries) {
      for (let d = 1; d <= daysCount; d++) {
        if (!isWeekend(timesheet.year, monthIndex, d)) continue;

        const exists =
          entry.days.some(day => day.dayNumber === d);

        if (exists) continue;

        await apiFetch(
          `/api/timesheets/${timesheetId}/employee/${entry.employee.id}/day` +
          `?dayOfMonth=${d}&status=DAY_OFF`,
          {method: 'POST'}
        );

        entry.days.push({
          dayNumber: d,
          status: 'DAY_OFF'
        });
      }
    }
  }

  /* ===================== RENDER ===================== */

  function renderTable() {
    const table = document.getElementById('timesheetTable');
    table.innerHTML = '';

    if (!timesheet || !timesheet.entries) return;

    const monthIndex = new Date(
      `${timesheet.year}-${timesheet.month}-01`
    ).getMonth();

    const daysCount =
      new Date(timesheet.year, monthIndex + 1, 0).getDate();

    // HEADER
    const head = document.createElement('tr');
    head.innerHTML = '<th>Сотрудник</th>';
    for (let d = 1; d <= daysCount; d++) {
      head.innerHTML += `<th>${d}</th>`;
    }
    table.appendChild(head);

    // ROWS
    timesheet.entries.forEach(entry => {
      const tr = document.createElement('tr');

      tr.innerHTML =
        `<td>${entry.employee.lastName} ${entry.employee.firstName}</td>`;

      for (let d = 1; d <= daysCount; d++) {
        const dayObj =
          entry.days.find(day => day.dayNumber === d);

        const status = dayObj?.status || '';

        const td = document.createElement('td');
        td.className = `day ${status}`;
        td.textContent = status ? status[0] : '';

        td.onclick = () =>
          changeStatus(entry.employee.id, d, td);

        tr.appendChild(td);
      }

      table.appendChild(tr);
    });
  }

  function renderEmployeeSelect() {
    const select = document.getElementById('employeeSelect');
    select.innerHTML = '<option value="">— выберите —</option>';

    const addedIds =
      timesheet.entries.map(e => e.employee.id);

    allEmployees
      .filter(e => !addedIds.includes(e.id))
      .forEach(e => {
        const option = document.createElement('option');
        option.value = e.id;
        option.textContent =
          `${e.lastName} ${e.firstName}`;
        select.appendChild(option);
      });
  }

  /* ===================== ACTIONS ===================== */

  async function changeStatus(employeeId, day, cell) {
    const currentIndex = STATUSES.findIndex(s =>
      cell.classList.contains(s)
    );

    const nextStatus = currentIndex === -1
      ? STATUSES[0]
      : STATUSES[(currentIndex + 1) % STATUSES.length];

    await apiFetch(
      `/api/timesheets/${timesheetId}/employee/${employeeId}/day` +
      `?dayOfMonth=${day}&status=${nextStatus}`,
      {method: 'POST'}
    );

    cell.className = `day ${nextStatus}`;
    cell.textContent = nextStatus[0];
  }

  async function addEmployee() {
    const select = document.getElementById('employeeSelect');
    const employeeId = select.value;

    if (!employeeId) {
      toast.error('Выберите сотрудника');
      return;
    }

    const res = await apiFetch(
      `${API}/${timesheetId}/employee?employeeId=${employeeId}`,
      {method: 'POST'}
    );

    timesheet = await res.json();

    toast.success('Сотрудник добавлен');
    await autofillWeekends();
    renderTable();
    renderEmployeeSelect();
  }

  /* ===================== INIT ===================== */

  loadTimesheet();
</script>

<script src="/js/ui-draggable.js"></script>
</body>
</html>
