<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Список сотрудников</title>

  <!--  <link rel="preconnect" href="https://fonts.googleapis.com">-->
  <!--  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>-->
  <!--  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">-->
  <style>
    /*body {*/
    /*  font-family: "Press Start 2P", "Courier New", monospace;*/
    /*  background-color: #327375;*/
    /*  color: #371a9f;*/
    /*  padding: 20px;*/
    /*}*/

    table, th, td {
      border: 1px solid black;
    }
  </style>
</head>
<body>
<h1>Список сотрудников</h1>
<a href="employee-create.html">[ ДОБАВИТЬ НОВОГО СОТРУДНИКА ]</a>

<div id="message"></div>

<table>
  <caption>Список подразделений</caption>
  <thead>
  <tr>
    <th>ID</th>
    <th>Фамилия</th>
    <th>Имя</th>
    <th>ИИН</th>
    <th>Email</th>
    <th>Действия</th>
  </tr>
  </thead>
  <tbody id="employeeTableBody">
  <tr>
    <td colspan="6" class="loading">Загрузка данных...</td>
  </tr>
  </tbody>

  <tfoot></tfoot>
</table>

<a href="index.html">[ ВЕРНУТЬСЯ НА ГЛАВНУЮ ]</a>

<script>
  // const API_URL = '/api/employees';
  const API_URL = 'http://localhost:8081/api/employees';

  let allEmployees = [];

  async function loadEmployees() {
    const tbody = document.getElementById('employeeTableBody');
    const messageDiv = document.getElementById('message');

    try {
      const response = await fetch(API_URL);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      allEmployees = data;

      // Отображаем все данные
      displayEmployees(data);
    } catch (error) {
      console.error('Ошибка при загрузке данных:', error);
      tbody.innerHTML = '<tr><td colspan="2" class="error">Ошибка загрузки данных</td></tr>';
      messageDiv.innerHTML = `<div class="error">Ошибка: ${error.message}</div>`;
    }
  }

  function displayEmployees(employees) {
    const tbody = document.getElementById('employeeTableBody');
    tbody.innerHTML = '';

    if (employees.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3">Нет данных</td></tr>';
      return;
    }

    employees.forEach((empl) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${empl.id}</td>
        <td>${empl.lastName}</td>
        <td>${empl.firstName}</td>
        <td>${empl.iin}</td>
        <td>${empl.email}</td>
        <td>
          <div class="actions">
            <button onclick="editEmployee(${empl.id})" title="Редактировать">[ EDIT ]</button>
            <button class="delete" onclick="deleteEmployee(${empl.id}, '${empl.firstName}')" title="Удалить">[ DELETE ]</button>
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  function searchEmployee() {
    const searchInput = document.getElementById('searchInput');
    const searchId = parseInt(searchInput.value);
    const messageDiv = document.getElementById('message');

    if (!searchId || isNaN(searchId)) {
      messageDiv.innerHTML = '<div style="color: #f44336; padding: 10px; margin: 10px 0; border: 2px solid #f44336;">Пожалуйста, введите корректный ID</div>';
      setTimeout(() => messageDiv.innerHTML = '', 2000);
      return;
    }

    const filteredEmployees = allEmployees.filter(empl => empl.id === searchId);

    if (filteredEmployees.length === 0) {
      messageDiv.innerHTML = '<div style="color: #ff9800; padding: 10px; margin: 10px 0; border: 2px solid #ff9800;">Сотрудник с таким ID не найден</div>';
      displayEmployees([]);
    } else {
      messageDiv.innerHTML = '';
      displayEmployees(filteredEmployees);
    }
  }

  function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('message').innerHTML = '';
    displayEmployees(allEmployees);
  }

  function editEmployee(id) {
    // Перенаправляем на страницу редактирования с ID в URL
    window.location.href = `employee-edit.html?id=${id}`;
  }

  async function deleteEmployee(id, firstName) {
    // Подтверждение удаления
    if (!confirm(`Вы уверены что хотите удалить подразделение "${firstName}"?`)) {
      return;
    }

    try {
      const response = await fetch(`${API_URL}/${id}`, {
        method: 'DELETE'
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`)
      }

      // Показываем сообщение об успехе
      const messageDiv = document.getElementById('message');
      messageDiv.innerHTML = '<div style="color: #0f0; padding: 10px; margin: 10px 0; border: 2px solid #0f0;">Сотрудник успешно удален!</div>';

      // Перезагружаем список
      setTimeout(() => {
        messageDiv.innerHTML = '';
        loadDepartments();
      }, 1500);
    } catch (error) {
      console.error('Ошибка при удалении:', error);
      const messageDiv = document.getElementById('message');
      messageDiv.innerHTML = `<div class="error">Ошибка при удалении: ${error.message}</div>`;
    }
  }

  // Загружаем данные при загрузке страницы
  window.addEventListener('DOMContentLoaded', loadEmployees);

  // Поиск при нажатии Enter
  document.addEventListener('DOMContentLoaded', () => {
    loadEmployees();
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        searchEmployee();
      }
    });
  });
</script>
</body>
</html>
