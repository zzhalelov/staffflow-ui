<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Список подразделений</title>

  <!--  <link rel="preconnect" href="https://fonts.googleapis.com">-->
  <!--  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>-->
  <!--  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">-->
  <style>
    /*body {*/
    /*  font-family: "Press Start 2P", "Courier New", monospace;*/
    /*  background-color: #327375;*/
    /*  color: #371a9f;*/
    /*  padding: 20px;*/
    /*}*/

    table, th, td {
      border: 1px solid black;
    }
  </style>
</head>
<body>
<h1>Список Подразделений</h1>
<a href="department-create.html">[ ДОБАВИТЬ НОВОЕ ПОДРАЗДЕЛЕНИЕ ]</a>

<div class="search-container">
  <label for="searchInput">Поиск по id</label>
  <input type="number" id="searchInput" placeholder="Введите id подразделения">
  <button onclick="searchDepartment()">[ НАЙТИ ]</button>
  <button class="clear-btn" onclick="clearSearch()">[ ОЧИСТИТЬ ]</button>
</div>

<div id="message"></div>

<table>
  <caption>Список подразделений</caption>
  <thead>
  <tr>
    <th>ID</th>
    <th>Наменование поразделения</th>
    <th>Действия</th>
  </tr>
  </thead>
  <tbody id="departmentTableBody">
  <tr>
    <td colspan="3" class="loading">Загрузка данных...</td>
  </tr>
  </tbody>

  <tfoot></tfoot>
</table>

<a href="index.html">[ ВЕРНУТЬСЯ НА ГЛАВНУЮ ]</a>

<script>
  const API_URL = '/api/departments';
  // const API_URL = 'http://localhost:8081/api/departments';

  let allDepartments = [];

  async function loadDepartments() {
    const tbody = document.getElementById('departmentTableBody');
    const messageDiv = document.getElementById('message');

    try {
      const response = await fetch(API_URL);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      allDepartments = data;

      // Отображаем все данные
      displayDepartments(data);
    } catch (error) {
      console.error('Ошибка при загрузке данных:', error);
      tbody.innerHTML = '<tr><td colspan="2" class="error">Ошибка загрузки данных</td></tr>';
      messageDiv.innerHTML = `<div class="error">Ошибка: ${error.message}</div>`;
    }
  }

  function editDepartment(id) {
    // Перенаправляем на страницу редактирования с ID в URL
    window.location.href = `department-edit.html?id=${id}`;
  }

  async function deleteDepartment(id, name) {
    // Подтверждение удаления
    if (!confirm(`Вы уверены что хотите удалить подразделение "${name}"?`)) {
      return;
    }

    try {
      const response = await fetch(`${API_URL}/${id}`, {
        method: 'DELETE'
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`)
      }

      // Показываем сообщение об успехе
      const messageDiv = document.getElementById('message');
      messageDiv.innerHTML = '<div style="color: #0f0; padding: 10px; margin: 10px 0; border: 2px solid #0f0;">Подразделение успешно удалено!</div>';

      // Перезагружаем список
      setTimeout(() => {
        messageDiv.innerHTML = '';
        loadDepartments();
      }, 1500);
    } catch (error) {
      console.error('Ошибка при удалении:', error);
      const messageDiv = document.getElementById('message');
      messageDiv.innerHTML = `<div class="error">Ошибка при удалении: ${error.message}</div>`;
    }
  }

  function displayDepartments(departments) {
    const tbody = document.getElementById('departmentTableBody');
    tbody.innerHTML = '';

    if (departments.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3">Нет данных</td></tr>';
      return;
    }

    departments.forEach((dept) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${dept.id}</td>
        <td>${dept.name}</td>
        <td>
          <div class="actions">
            <button onclick="editDepartment(${dept.id})" title="Редактировать">[ EDIT ]</button>
            <button class="delete" onclick="deleteDepartment(${dept.id}, '${dept.name}')" title="Удалить">[ DELETE ]</button>
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  function searchDepartment() {
    const searchInput = document.getElementById('searchInput');
    const searchId = parseInt(searchInput.value);
    const messageDiv = document.getElementById('message');

    if (!searchId || isNaN(searchId)) {
      messageDiv.innerHTML = '<div style="color: #f44336; padding: 10px; margin: 10px 0; border: 2px solid #f44336;">Пожалуйста, введите корректный ID</div>';
      setTimeout(() => messageDiv.innerHTML = '', 2000);
      return;
    }

    const filteredDepartments = allDepartments.filter(dept => dept.id === searchId);

    if (filteredDepartments.length === 0) {
      messageDiv.innerHTML = '<div style="color: #ff9800; padding: 10px; margin: 10px 0; border: 2px solid #ff9800;">Департамент с таким ID не найден</div>';
      displayDepartments([]);
    } else {
      messageDiv.innerHTML = '';
      displayDepartments(filteredDepartments);
    }
  }

  function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('message').innerHTML = '';
    displayDepartments(allDepartments);
  }

  // Загружаем данные при загрузке страницы
  window.addEventListener('DOMContentLoaded', loadDepartments);

  // Поиск при нажатии Enter
  document.addEventListener('DOMContentLoaded', () => {
    loadDepartments();
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        searchDepartment();
      }
    });
  });
</script>

</body>
</html>
