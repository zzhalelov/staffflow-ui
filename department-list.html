<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Список подразделений</title>

  <!--  <link rel="preconnect" href="https://fonts.googleapis.com">-->
  <!--  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>-->
  <!--  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">-->
  <style>
    /*body {*/
    /*  font-family: "Press Start 2P", "Courier New", monospace;*/
    /*  background-color: #327375;*/
    /*  color: #371a9f;*/
    /*  padding: 20px;*/
    /*}*/

    table, th, td {
      border: 1px solid black;
    }
  </style>
</head>
<body>
<h1>Список Подразделений</h1>
<a href="department-create.html">[ ДОБАВТЬБ НОВОЕ ПОДРАЗДЕЛЕНИЕ ]</a>

<div id="message"></div>

<table>
  <caption>Список подразделений</caption>
  <thead>
  <tr>
    <th>ID</th>
    <th>Наменование поразделения</th>
    <th>Действия</th>
  </tr>
  </thead>
  <tbody id="departmentTableBody">
  <tr>
    <td colspan="3" class="loading">Загрузка данных...</td>
  </tr>
  </tbody>

  <tfoot></tfoot>
</table>

<a href="index.html">[ ВЕРНУТЬСЯ НА ГЛАВНУЮ ]</a>

<script>
  const API_URL = '/api/departments';

  // const API_URL = 'http://localhost:8081/api/departments';

  async function loadDepartments() {
    const tbody = document.getElementById('departmentTableBody');
    const messageDiv = document.getElementById('message');

    try {
      const response = await fetch(API_URL);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();

      tbody.innerHTML = '';

      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">Нет данных</td></tr>';
        return;
      }

      data.forEach((dept) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${dept.id}</td>
            <td>${dept.name}</td>
            <td>
            <div class="actions">
            <button onclick="editDepartment(${dept.id})" title="Редактировать">[ EDIT ]</button>
            <button class="delete" onclick="deleteDepartment(${dept.id}, '${dept.name}')" title="Удалить">[ DELETE ]</button>
            </div>
        </td>
        `;
        tbody.appendChild(row);
      });
    } catch (error) {
      console.error('Ошибка при загрузке данных:', error);
      tbody.innerHTML = '<tr><td colspan="2" class="error">Ошибка загрузки данных</td></tr>';
      messageDiv.innerHTML = `<div class="error">Ошибка: ${error.message}</div>`;
    }
  }

  function editDepartment(id) {
    // Перенаправляем на страницу редактирования с ID в URL
    window.location.href = `department-edit.html?id=${id}`;
  }

  async function deleteDepartment(id, name) {
    // Подтверждение удаления
    if (!confirm(`Вы уверены что хотите удалить подразделение "${name}"?`)) {
      return;
    }

    try {
      const response = await fetch(`${API_URL}/${id}`, {
        method: 'DELETE'
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`)
      }

      // Показываем сообщение об успехе
      const messageDiv = document.getElementById('message');
      messageDiv.innerHTML = '<div style="color: #0f0; padding: 10px; margin: 10px 0; border: 2px solid #0f0;">Подразделение успешно удалено!</div>';

      // Перезагружаем список
      setTimeout(() => {
        messageDiv.innerHTML = '';
        loadDepartments();
      }, 1500);
    } catch (error) {
      console.error('Ошибка при удалении:', error);
      const messageDiv = document.getElementById('message');
      messageDiv.innerHTML = `<div class="error">Ошибка при удалении: ${error.message}</div>`;
    }
  }

  // Загружаем данные при загрузке страницы
  window.addEventListener('DOMContentLoaded', loadDepartments);
</script>

</body>
</html>
